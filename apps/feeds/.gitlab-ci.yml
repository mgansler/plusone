feeds:test:
  services:
    - docker:dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
    DOCKER_DRIVER: overlay2
  stage: test
  tags:
    - docker
  script:
    - yarn nx run-many --target test --projects feeds-backend
  after_script:
    - yarn jrm reports/test/junit-feeds.xml reports/test/test-*.xml
  artifacts:
    when: always
    reports:
      junit:
        - reports/test/junit-feeds.xml

feeds:build:
  stage: build
  needs:
    - lint
    - feeds:test
  tags:
    - docker
  parallel:
    matrix:
      - FEEDS_APP:
          - backend
  script:
    - yarn nx run feeds-${FEEDS_APP}:build:production
  artifacts:
    paths:
      - dist/apps/feeds/${FEEDS_APP}
    expire_in: 1 hour

feeds:package:
  cache: []
  image: docker
  services:
    - docker:dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
    DOCKER_DRIVER: overlay2
  stage: package
  needs:
    - feeds:build
  tags:
    - docker
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: manual
  before_script:
    - docker login -u "gitlab-ci-token" -p "${CI_JOB_TOKEN}" ${CI_REGISTRY}
    - export DOCKER_IMAGE_NAME=${CI_REGISTRY_IMAGE}/feeds/${CI_COMMIT_REF_SLUG}:latest
  script:
    - docker build -f apps/feeds/${FEEDS_APP}/Dockerfile -t ${DOCKER_IMAGE_NAME} .
    - docker push ${DOCKER_IMAGE_NAME}

feeds:deploy:
  cache: []
  stage: deploy
  needs:
    - feeds:package
  tags:
    - deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: manual
  variables:
    FEEDS_BACKEND_DOCKER_IMAGE: ${CI_REGISTRY_IMAGE}/feeds-backend/${CI_COMMIT_REF_SLUG}:latest
  before_script:
    - docker login -u "gitlab-ci-token" -p "${CI_JOB_TOKEN}" ${CI_REGISTRY}
    - docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
  script:
    - docker compose -f apps/feeds/docker-compose.deploy.yml pull
    - docker compose -f apps/feeds/docker-compose.deploy.yml up -d --remove-orphans
